<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="favicon.ico">

    <title>Dropboxtest</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropbox.js/2.5.2/Dropbox-sdk.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
    <script type="text/javascript">
    (function(window){
    window.utils = {
      parseQueryString: function(str) {
        var ret = Object.create(null);

        if (typeof str !== 'string') {
          return ret;
        }

        str = str.trim().replace(/^(\?|#|&)/, '');

        if (!str) {
          return ret;
        }

        str.split('&').forEach(function (param) {
          var parts = param.replace(/\+/g, ' ').split('=');
          // Firefox (pre 40) decodes `%3D` to `=`
          // https://github.com/sindresorhus/query-string/pull/37
          var key = parts.shift();
          var val = parts.length > 0 ? parts.join('=') : undefined;

          key = decodeURIComponent(key);

          // missing `=` should be `null`:
          // http://w3.org/TR/2012/WD-url-20120524/#collect-url-parameters
          val = val === undefined ? null : decodeURIComponent(val);

          if (ret[key] === undefined) {
            ret[key] = val;
          } else if (Array.isArray(ret[key])) {
            ret[key].push(val);
          } else {
            ret[key] = [ret[key], val];
          }
        });

        return ret;
      }
    };
  })(window);
   
  </script>
  </head>

  <body>

    <ul id="results"></ul>

    <a href="" style="display:none;" id="authlink" class="button">Authenticate</a>

    <script type="text/javascript">

      var APP_ID = 'zp4u1zuvtzgin6g';
      token = 'asdasfafas';
      console.log('DB_token: ' + token);

      var DB_token = utils.parseQueryString(window.location.hash).access_token;
      if(DB_token){
          // gerade von DB zurÃ¼ck, also Show config
          token = DB_token;
      }

    function gclh_sync_DB_showAuthLink(){

      console.log('gclh_sync_DB_showAuthLink');

      var APP_ID = 'zp4u1zuvtzgin6g';
      // If client could not created, try to get a new Auth token
      // Set the login anchors href using dropbox_client.getAuthenticationUrl()
      dropbox_auth_client = new Dropbox({ clientId: APP_ID });
      authlink = document.getElementById('authlink');
      authlink.href = dropbox_auth_client.getAuthenticationUrl('https://www.geocaching.com/my/default.aspx');
      $(authlink).show();

      console.log('gclh_sync_DB_showAuthLink: done');
    }
  
    function gclh_sync_DB_CheckAndCreateClient() {
        
        var deferred = $.Deferred();

        if (token) {
          // Try to create an instance and test it with the current token
          dropbox_client = new Dropbox({ accessToken: token });
          
          dropbox_client.usersGetCurrentAccount()
            .then(function(response) {
              console.log('usersGetCurrentAccount response');
              console.log(response);
              deferred.resolve();
            })
            .catch(function(error) {
              console.log('usersGetCurrentAccount error:' + error.error);
              console.error(error);

              gclh_sync_DB_showAuthLink();

              deferred.reject();
            });

        }else{
            // No token was givven, to try to auth laten in this function
            console.log('No Token givven. => Reauth');
            dropbox_client = null;

            gclh_sync_DB_showAuthLink();

            deferred.reject();
        }

        return deferred.promise();
    }


    gclh_sync_DB_CheckAndCreateClient()
      .done(function(){
        alert('Success');
      })
      .fail(function(){
        alert('Something went horrible wrong! So reauth.');
      });
    
  </script>
  </body>
</html>